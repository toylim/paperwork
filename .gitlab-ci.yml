image: debian:bullseye

variables:
  GIT_STRATEGY: clone
  GIT_SUBMODULE_STRATEGY: none

stages:
  # no point in waiting for the tests to end before generating the data files
  # or the development documentation
  - tests
  - data
  - deploy

check:
  stage: tests
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
    - merge_requests
  tags:
    - linux
    - volatile
  script:
    - apt-get update
    - apt-get install -y
        flake8
        make
        pycodestyle
        python3-flake8
    - make check


test:
  stage: tests
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
    - merge_requests
  tags:
    - linux
    - volatile
  script:
    - apt-get update
    - apt-get install -y
        build-essential
        gcc
        gettext
        git
        gobject-introspection
        gtk-doc-tools
        libcunit1-ncurses-dev
        libgirepository1.0-dev
        libjpeg-dev
        libsane-dev
        make
        meson
        python3-dev
        python3-gi
        python3-pil
        python3-scipy
        tox
        valac
        wget
        xvfb
        zlib1g-dev
    - source ./activate_test_env.sh && make install
    - source ./activate_test_env.sh && paperwork-gtk chkdeps -y
    - source ./activate_test_env.sh && paperwork-cli chkdeps -y
    - source ./activate_test_env.sh && make test


test_chkdeps:
  stage: tests
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
    - merge_requests
  tags:
    - linux
    - volatile
  script:
    - apt-get update
    # bare minimum to install Paperwork from sources
    - apt-get install -y
        build-essential
        gettext
        make
        python3
        python3-dev
        python3-pip
        python3-setuptools
        wget
    - make install
    - paperwork-json chkdeps


generate_data:
  stage: data
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
  tags:
    - linux
    - volatile
  script:
    - echo deb http://deb.debian.org/debian buster-backports main > /etc/apt/sources.list.d/backports.list
    - apt-get update
    - apt-get install -y
        build-essential
        doxygen
        gcc
        gettext
        git
        gobject-introspection
        graphviz
        gtk-doc-tools
        imagemagick
        libcunit1-ncurses-dev
        libgirepository1.0-dev
        libjpeg-dev
        libsane-dev
        make
        meson
        po4a
        python3-dev
        python3-gi
        python3-pil
        python3-virtualenv
        rclone
        texlive
        texlive-lang-english
        texlive-lang-french
        texlive-lang-german
        texlive-latex-extra
        texlive-latex-recommended
        valac
        valgrind
        virtualenv
        wget
        xvfb
        zlib1g-dev
    - source ./activate_test_env.sh && make install
    - source ./activate_test_env.sh && xvfb-run paperwork-gtk chkdeps -y
    - source ./activate_test_env.sh && xvfb-run paperwork-cli chkdeps -y
    - source ./activate_test_env.sh && make data upload_data


doc_devel:
  stage: data
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
  tags:
    - linux
    - volatile
  script:
    - apt-get update
    - apt-get install -y
        build-essential
        doxygen
        gettext
        git
        gobject-introspection
        graphviz
        gtk-doc-tools
        libcunit1-ncurses-dev
        libgirepository1.0-dev
        libsane-dev
        make
        meson
        openjdk-11-jre
        plantuml
        plantuml
        python3-dev
        python3-gi
        python3-pil
        python3-recommonmark
        python3-sphinx
        python3-sphinxcontrib.plantuml
        python3-virtualenv
        rclone
        valac
        valgrind
        virtualenv
        wget
        zlib1g-dev
    - source ./activate_test_env.sh && make doc
    - source ./activate_test_env.sh && make upload_doc


linux_flatpak:
  stage: deploy
  timeout: 48h
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
  tags:
    - openpaper-flatpak
  script:
    # Running in from a gitlab-runner directly in a shell, as the user
    # 'gitlab-runner'
    # --> not running as root, so we cannot actually install anything
    # - apt-get update
    # - apt-get install -y -q rsync flatpak-builder make
    - ./ci/update_flatpak_repo.sh

linux_appimage:
  stage: deploy
  timeout: 2h
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
  tags:
    - linux
    - volatile
  script:
    - apt-get update
    # Libinsane build dependencies
    # WORKAROUND(Jflesch): manpages is required to install some of the
    # openjdk-jre and openjdk-jre is required for plantuml, which is required
    # to generate documentation
    - mkdir -p /usr/share/man/man1
    - apt-get install -y -q
        build-essential
        cmake
        gobject-introspection
        libcunit1-ncurses-dev
        libgirepository1.0-dev
        libsane-dev
        make
        meson
        valac
        valgrind
    - apt-get install --no-install-recommends -y -q
        doxygen
        graphviz
        gtk-doc-tools
        plantuml
    # Paperwork non-Python dependencies
    - apt-get install -y -q
        ca-certificates
        gettext
        git
        python3-pefile
        python3-dev
        python3-pip
        python3-pkg-resources
        python3-setuptools
        python3-wheel
        rclone
        wget
    # AppImage dependencies
    - apt-get install -y -q
        binutils
        coreutils
        desktop-file-utils
        fakeroot
        fuse3
        libgdk-pixbuf2.0-dev
        patchelf
        python3-importlib-metadata
        squashfs-tools
        strace
        util-linux
        zsync
    - pip3 install appimage-builder
    # Build
    - make linux_exe
    - ./ci/deliver.sh paperwork-gtk/Paperwork-gtk-latest-x86_64.AppImage linux .appimage paperwork-gtk
    - ./ci/deliver.sh paperwork-cli/Paperwork-cli-latest-x86_64.AppImage linux .appimage paperwork-cli
    - ./ci/deliver.sh paperwork-shell/Paperwork-json-latest-x86_64.AppImage linux .appimage paperwork-json
  artifacts:
    expire_in: 2 days
    paths:
      - paperwork-gtk/Paperwork-gtk-latest-x86_64.AppImage
      - paperwork-shell/Paperwork-cli-latest-x86_64.AppImage
      - paperwork-shell/Paperwork-json-latest-x86_64.AppImage


.windows: &windows
  variables:
    MSYSTEM: "MINGW64"
    CHERE_INVOKING: "yes"
  before_script:
    # Libinsane build dependencies
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S make
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-cunit
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-doxygen
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-gcc
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-gobject-introspection
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-meson
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-python3-gobject
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-vala
    # Paperwork build dependencies
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-gdk-pixbuf2
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-cairo
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-python3-cairo
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-gtk3
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-python3-pillow
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-ca-certificates
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-python3-setuptools
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-python3-pip
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-libhandy
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-libnotify
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-poppler
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-python-psutil
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-gettext
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S git  # for 'make version'
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S wget  # for downloading data files
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-python3-cx_Freeze
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S zip unzip
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-nsis
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-nsis-nsisunz
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-python-scikit-learn
    # Workaround for pycountry and Cx_freeze
    # See https://github.com/marcelotduarte/cx_Freeze/issues/930
    - c:\msys64\usr\bin\bash -lc "pip3 uninstall -y pycountry"
    - c:\msys64\usr\bin\bash -lc "pip3 install --no-cache --use-pep517 pycountry==20.7.3"
    - git submodule init
    - git submodule update --recursive --remote
    - c:\msys64\usr\bin\bash -lc "make clean"
    - c:\msys64\usr\bin\bash -lc "make uninstall"
    - c:\msys64\usr\bin\bash -lc "make -C sub/libinsane uninstall || true"
    - c:\msys64\usr\bin\bash -lc "make -C sub/libpillowfight uninstall || true"
    - c:\msys64\usr\bin\bash -lc "make -C sub/pyocr uninstall || true"
    # a 2nd time just to be really sure
    # (that's the problem when can't use containers ..)
    - c:\msys64\usr\bin\bash -lc "make uninstall"
    - c:\msys64\usr\bin\bash -lc "make -C sub/libinsane uninstall || true"
    - c:\msys64\usr\bin\bash -lc "make -C sub/libpillowfight uninstall || true"
    - c:\msys64\usr\bin\bash -lc "make -C sub/pyocr uninstall || true"


windows_tests:
  stage: tests
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
    - merge_requests
  tags:
    - windows
    - msys2
  <<: *windows
  script:
    # Tesseract (required for unit tests)
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-libarchive  # missing tesseract dependency
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-tesseract-ocr
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-tesseract-data-eng
    - c:\msys64\usr\bin\pacman --needed --noconfirm -S mingw-w64-x86_64-tesseract-data-fra
    # Build
    - c:\msys64\usr\bin\bash -lc "export TESSDATA_PREFIX=/mingw64/share/tessdata && make install test"
    - c:\msys64\usr\bin\bash -lc "make uninstall"


windows_exe:
  stage: deploy
  only:
    - branches@World/OpenPaperwork/paperwork
    - tags@World/OpenPaperwork/paperwork
  tags:
    - windows
    - msys2
  <<: *windows
  script:
    # We need rclone to upload the files on OVH object storage
    - c:\msys64\usr\bin\rm -f rclone-v1.53.3-windows-386.zip
    - c:\msys64\usr\bin\rm -rf rclone-v1.53.3-windows-386
    - c:\msys64\usr\bin\wget -q https://github.com/rclone/rclone/releases/download/v1.53.3/rclone-v1.53.3-windows-386.zip
    - c:\msys64\usr\bin\unzip rclone-v1.53.3-windows-386.zip
    - c:\msys64\usr\bin\cp rclone-v1.53.3-windows-386/rclone.exe /usr/bin
    # Build
    - c:\msys64\usr\bin\bash -lc "make windows_exe"
    - c:\msys64\usr\bin\bash -lc "./ci/deliver.sh dist/paperwork.zip windows .zip"
    - c:\msys64\usr\bin\bash -lc "make uninstall"
